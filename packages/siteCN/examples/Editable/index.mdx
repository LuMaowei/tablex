---
name: 编辑
---

import { Playground, Props } from "docz";
import Table, { flatten } from "tablex";
import { Input, InputNumber, Select, DatePicker, Switch, Checkbox,Button } from "antd";

import Complex from "./complex";
import CustomEdit from "./customEdit";


# 用法示例

```javascript
import Table, { flatten, unflatten } from "sy-framework/lib/widget/table";
```

## 基本编辑及验证

<Playground style={{ height: 400 }}>
 {
  class Demo extends React.Component {
  generateData(columns, count = 20, prefix = "Row") {
    return new Array(count).fill(0).map((row, rowIndex) => {
      return columns.reduce(
        (rowData, column, columnIndex) => {
          if (column.dataIndex !== "id") {
            rowData[column.dataIndex] = Math.floor(Math.random() * 100 + 1);
          } else {
            rowData[column.dataIndex] =
              prefix + " " + rowIndex + " - Col " + columnIndex;
          }

          return rowData;
        },
        {
          id: prefix + rowIndex,
          parentId: null
        }
      );
    });

}

constructor(props) {
super(props);

    const columns = [
      {
        dataIndex: "id",
        title: "id",
        key: "id",
        width: 150
      },
      {
        dataIndex: "column-1",
        title: "column-1",
        width: 100,
          validator: function(value, row) {
          if (!value) {
            return { valid: false, message: "请输入" };
          }

          return { valid: true, message: "false" };
        },
        editor: function(value, row, index, onchange, ref) {
          return (
            <Input
              defaultValue={value}
              ref={ref}
              onChange={e => onchange({ ["column-1"]: e.target.value })}
            />
          );
        }
      },

      {
        dataIndex: "column-2",
        title: "column-2",
        width: 150,
        align: "center"
      },

      {
        dataIndex: "column-3",
        title: "column-3",
        align: "right"
      },
      {
        dataIndex: "column-4",
        title: "column-4",
        width: 100,
        align: "center"
      }
    ];

    let data =  this.generateData(columns,10);

     data[1].children =  this.generateData(columns,3,"children-");


    this.state = {
      data: data,
      columns: columns
    };

}

onEditSave(changedRows, newData, type) {
console.log("onEditSave:", newData);
this.setState({
data: newData
});
}

render() {
let { columns, data } = this.state;

    return (
      <Table
        rowKey="id"
        columns={columns}
        validateTrigger="onChange"
        data={data}
        editable={true}
        selectMode={"multiple"}
        checkStrictly={false}
        editTools={['edit', 'add','delete']}
        onEditSave={this.onEditSave.bind(this)}
      />
    );

}
}

}

</Playground>

## 编辑器无边框

<Playground style={{ height: 600 }}>
 {
  class Demo extends React.Component {
  generateData(columns, count = 20, prefix = "Row") {
    return new Array(count).fill(0).map((row, rowIndex) => {
      return columns.reduce(
        (rowData, column, columnIndex) => {
          if (column.dataIndex !== "id") {
            rowData[column.dataIndex] = Math.floor(Math.random() * 100 + 1);
          } else {
            rowData[column.dataIndex] =
              prefix + " " + rowIndex + " - Col " + columnIndex;
          }

          return rowData;
        },
        {
          id: prefix + rowIndex,
          parentId: null
        }
      );
    });

}

constructor(props) {
super(props);

    const columns = [
      {
        dataIndex: "id",
        title: "id",
        key: "id",
        width: 150
      },
      {
        dataIndex: "column-1",
        title: "column-1",
        width: 100,
          validator: function(value, row) {
          if (!value) {
            return { valid: false, message: "请输入" };
          }

          return { valid: true, message: "false" };
        },
        editor: function(value, row, index, onchange, ref) {
          return (
            <Input
              defaultValue={value}
              ref={ref}
              onChange={e => onchange({ ["column-1"]: e.target.value })}
            />
          );
        }
      },

      {
        dataIndex: "column-2",
        title: "column-2",
        width: 150,
        align: "center",
          validator: function(value, row) {
          if (!value) {
            return { valid: false, message: "请输入" };
          }

          return { valid: true, message: "false" };
        },
        editor: function(value, row, index, onchange, ref) {
          return (
            <InputNumber
              defaultValue={value}
              ref={ref}
              onChange={e => onchange({ ["column-2"]: e.target.value })}
            />
          );
        }
      },

      {
        dataIndex: "column-3",
        title: "column-3",
        align: "right",
          validator: function(value, row) {
          if (!value) {
            return { valid: false, message: "请输入" };
          }

          return { valid: true, message: "false" };
        },
        editor: function(value, row, index, onchange, ref) {
          return (
            <Select
              defaultValue={value}
              ref={ref}
              onChange={e => onchange({ ["column-3"]: e.target.value })}
            />
          );
        }
      },
      {
        dataIndex: "column-4",
        title: "column-4",
        width: 100,
        align: "center",
          validator: function(value, row) {
          if (!value) {
            return { valid: false, message: "请输入" };
          }

          return { valid: true, message: "false" };
        },
        editor: function(value, row, index, onchange, ref) {
          return (
            <DatePicker
              placeholder=""
              ref={ref}
              onChange={e => onchange({ ["column-4"]: e.target.value })}
            />
          );
        }
      },
      {
        dataIndex: "column-5",
        title: "column-5",
        width: 100,
        align: "center",
          validator: function(value, row) {
          if (!value) {
            return { valid: false, message: "请输入" };
          }

          return { valid: true, message: "false" };
        },
        editor: function(value, row, index, onchange, ref) {
          return (
            <Switch
              ref={ref}
              onChange={e => onchange({ ["column-5"]: e.target.value })}
            />
          );
        }
      }
    ];

    let data =  this.generateData(columns,10);

     data[1].children =  this.generateData(columns,3,"children-");


    this.state = {
      data: data,
      columns: columns
    };

}

onEditSave(changedRows, newData, type) {
console.log("onEditSave:", newData);
this.setState({
data: newData
});
}

componentDidMount() {
this.refs.tableRef.api.editAll()
}

render() {
let { columns, data } = this.state;

    return (
      <Table
        rowKey="id"
        ref="tableRef"
        columns={columns}
        validateTrigger="onChange"
        data={data}
        editorNoBorder={true}
        editable={true}
        selectMode={"multiple"}
        checkStrictly={false}
        editTools={['edit', 'add','delete']}
        onEditSave={this.onEditSave.bind(this)}
      />
    );

}
}

}

</Playground>


## 自定义编辑

<Playground style={{ height: 600 }}>
{
  class Demo extends React.Component {
  constructor(props) {
    super(props);

    this.tableRef = React.createRef();

    this.state = {
      data: [],
      loading: false,
      expandedRowKeys: []
    };

    this.columns = [
      {
        dataIndex: "column-1",
        key: "column-1",
        title: "column-1",
        align: "left",
        halign: "center",
        minWidth: 300,
        onCell: (row, value, index) => {
          return {
            onClick: () => {
              this.beginEdit(row);
            }
          };
        },
        validator: function(value, row) {
          if (!value) {
            return { valid: false, message: "请输入" };
          }

          return { valid: true, message: "false" };
        },
        editor: function(value, row, index, onchange, ref) {
          return (
            <Input
              defaultValue={value}
              ref={ref}
              onChange={e =>
                onchange([
                  { "column-1": e.target.value, id: row.id },
                  { id: "3", address: e.target.value }
                ])
              }
            />
          );
        }
      },
      {
        title: "appellation",
        width: 150,
        halign: "left",
        children: [
          {
            dataIndex: "address",
            title: "name",
            width: 200,
            onCell: (row, value, index) => {
              return {
                onClick: () => {
                  this.beginEdit(row);
                }
              };
            },
            editor: function(value, row, index, onchange, ref) {
              return (
                <Input
                  defaultValue={value}
                  ref={ref}
                  onChange={e => onchange({ address: e.target.value })}
                />
              );
            }
          },
          {
            title: "nick name",
            width: 150,
            children: [
              {
                dataIndex: "id",
                title: "nick-1",
                maxWidth: 300,
                width: 150
              },
              {
                dataIndex: "level",
                title: "level"
              }
            ]
          }
        ]
      },
      {
        dataIndex: "id",
        key: "column-4",
        title: "id"
      }
    ];
  }

  componentDidMount() {
    function createData(level, parentKey, maxLevel, index) {
      if (level > maxLevel) {
        return;
      }

      let l = level;
      let data = [];
      for (let i = 0; i < 3; i++) {
        let k = parentKey + "-" + level + "-" + i;
        let d = {
          id: k,
          "column-1": "Edward King " + k,
          age: 32,
          level: level,
          address: "London, Park Lane no. " + i
        };

        if (i === 2) {
          d.children = createData(l + 1, k, maxLevel, i);
        }

        data.push(d);
      }
      return data;
    }

    function createTreeData() {
      let data = [];
      for (let i = 0; i < 10; i++) {
        let childrens = createData(0, i, 2);
        let d = {
          id: "" + i,
          level: 0,
          "column-1": "Edward King " + i,
          age: i,
          address: "London, Park Lane no. " + i
        };

        if (i % 3 === 0) {
          d.children = childrens;
        }

        data.push(d);
      }

      return data;
    }

    this.setState({
      data: createTreeData()
    });
  }

  beginEdit(row) {
    let arr = [];
    arr.push(row.id);
    this.tableRef.current.api.editRows(arr);
  }

  completeEdit() {
    this.tableRef.current.api.completeEdit();
  }

  cancelEdit() {
    this.tableRef.current.api.cancelEdit();
  }

  insertData() {
    let arr = [];
    arr.push({ id: "inserted-row-" + new Date().getTime() });

    this.tableRef.current.api.insertData({
      data: arr,
      parentKey: "3",
      editing: true,
      prepend: false,
      startIndex: 2
    });
  }

  modifyData() {
    let arr = [];
    arr.push({ id: "inserted-row-" + new Date().getTime() });

    this.tableRef.current.api.modifyData([
      {
        id: "3",
        "column-1": "modifyData-" + new Date().getTime(),
        level: 3
      }
    ]);
  }

  delete() {
    this.tableRef.current.api.deleteData();
  }

  onEditSave(changedRows, newRows, editType) {
    console.log("onEditSave changedRows:", changedRows);
    console.log("onEditSave newRows:", newRows);
    this.setState({ data: newRows });
  }

  render() {
    return (
      <div style={{ height: "100%" }}>
        <Table
          header={() => {
            return (
              <div>
                <Button
                  onClick={this.completeEdit.bind(this)}
                  style={{ cursor: "pointer" }}
                >
                  complete edit
                </Button>

                <Button
                  onClick={this.cancelEdit.bind(this)}
                  style={{ cursor: "pointer", marginLeft: 10 }}
                >
                  cancel edit
                </Button>

                <Button
                  onClick={this.insertData.bind(this)}
                  style={{ cursor: "pointer", marginLeft: 10 }}
                >
                  insert data
                </Button>

                <Button
                  onClick={this.modifyData.bind(this)}
                  style={{ cursor: "pointer", marginLeft: 10 }}
                >
                  modify data
                </Button>

                <Button
                  onClick={this.delete.bind(this)}
                  style={{ cursor: "pointer", marginLeft: 10 }}
                >
                  delete
                </Button>
              </div>
            );
          }}
          editable={false}
          isAppend={true}
          allowSaveEmpty={true}
          alwaysValidate={true}
          ref={this.tableRef}
          rowKey="id"
          onEditSave={this.onEditSave.bind(this)}
          columns={this.columns}
          selectMode="multiple"
          checkStrictly={false}
          data={this.state.data}
          validateTrigger="onChange"
          selectOnRowClick={false}
        />
      </div>
    );
  }
}
}
</Playground>

### 相关api

> Table提供了一组针对数据编辑的api，可以使用这些方法快捷的编辑数据

```javascript
 api= {
    /** 编辑指定行
     * @rowKeys 数据行key集合
     */
    editRows:(rowKeys=[])=>{},
    /** 编辑所有 */
    editAll: ()=>{},
    /** 
     * 删除数据 
     * @rowKeys 数据行key集合，不传入时，默认删除当前选中的行
     * */
    deleteData:()=>{},
    /** 插入数据 */
    insertData: ({ 
        data = [],//需要插入的行数据集合
        parentKey = "",//所属父级，默认根级
        editing = false, //插入后，是否需要处于编辑状态
        prepend = false, //parentKey有效时可用，可以控制插入的数据在父级的首行还是末行
        scrollTo = true, //插入数据后，是否自动滚动到对应行
        startIndex = -1  //无parentKey时有效，控制数据插入到根级的第几行
    })=>{},
    /** 
     * 修改数据 
     * rows 需要修改的数据（平级），数据中必须包含rowKey
     * */
    modifyData:(rows=[{rowKey,...}])=>{},
    /** 
     * 完成编辑，并提交数据更改
     * 每次调用此方法，都将会触发onEditSave，可以在onEditSave事件中统一对数据进行保存操作
     * */
    completeEdit: ()=>{},
    /** 
     * 取消编辑 
     * 调用此方法后，上次未提交的数据更改将被放弃
     * */
    cancelEdit:()=>{}
 }

```

## 大数据量树形数据编辑

<Playground style={{ height: 600 }}>
  <Complex />
</Playground>
